<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>KokoriConnect</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="KokoriConnect">
    
    <link rel="apple-touch-icon" href="accueil.PNG">
    <link rel="icon" type="image/png" href="accueil.PNG">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #4e23af; --danger: #e74c3c; --success: #2ecc71; --warning: #f1c40f; --info: #3498db; --dark: #2c3e50; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(to bottom, #ffffff, var(--primary));
            min-height: 100vh; margin: 0; padding: 0; color: #333; text-align: center;
            padding-bottom: 120px;
        }

        /* HEADER */
        .header { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; padding: 15px; gap: 10px; }
        .mon-logo { width: 120px; height: auto; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        
        h1 { color: var(--dark); margin: 10px 0 20px 0; font-size: 1.8em; text-transform: capitalize; }
        
        .status-pill { padding: 8px 15px; border-radius: 20px; font-size: 0.85em; font-weight: bold; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .weather-widget { background: rgba(255,255,255,0.9); padding: 8px 20px; border-radius: 20px; font-size: 0.9em; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; }

        /* ONGLETS */
        .tab-content { display: none; padding: 10px; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARTES */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(145px, 1fr)); gap: 15px; max-width: 1100px; margin: auto; }
        .card { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; text-align: left; }
        .card h3 { margin: 0; font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; }
        .card p { font-size: 1.6em; font-weight: bold; margin: 8px 0; color: var(--dark); }
        .card-icon { position: absolute; top: 10px; right: 10px; font-size: 1.2em; opacity: 0.2; }
        .level-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 8px; }
        .level-fill { height: 100%; width: 0%; transition: 1s ease-in-out; }
        .chart-container { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 250px; margin-bottom: 20px; }
        
        /* RESTAURATION DU STYLE EXACT DES ACTIONS */
        .control-panel { background: white; border-radius: 20px; padding: 25px; max-width: 600px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: left; }
        .control-panel h3 { margin-top: 0; margin-bottom: 15px; color: var(--dark); font-size: 1.1em; border-bottom: none; }
        
        /* Badge d'√©tat (Le fameux "--" gris √† droite) */
        .status-label { 
            float: right;
            font-weight: bold; 
            padding: 4px 12px; 
            border-radius: 6px; 
            background: #f0f0f0; 
            color: #555;
            font-size: 0.9em;
        }

        /* BOUTONS (Style d'origine) */
        .btn { 
            padding: 15px 0; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            color: white; 
            font-weight: bold; 
            font-size: 1em;
            transition: 0.2s; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); 
            width: 100%; 
            margin-bottom: 10px;
        }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        
        .btn-open { background-color: var(--success); }
        .btn-close { background-color: var(--danger); }
        .btn-clean { background-color: var(--info); }
        .btn-export { background-color: var(--dark); margin-top: 5px; }
        .btn-save { background-color: var(--primary); margin-top: 10px; }

        /* FORMULAIRES */
        .settings-group { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; text-align: left; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .settings-group h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; box-sizing: border-box; }
        .form-select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1em; background: white; }

        /* NAVIGATION BAS (FontAwesome - Propre) */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; width: 100%; background: white; 
            display: flex; justify-content: space-around; padding: 12px 0 25px 0; 
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1); z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { 
            background: none; border: none; font-size: 0.8em; display: flex; flex-direction: column; 
            align-items: center; cursor: pointer; flex: 1; transition: 0.3s; color: #300a6e; opacity: 0.6;
        }
        .nav-icon { font-size: 26px; margin-bottom: 4px; transition: 0.3s; }
        .nav-item.active { color: #a569bd; opacity: 1; font-weight: bold; }
        .nav-item.active .nav-icon { transform: scale(1.2); }

        /* MODAL */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 20% auto; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <div id="modal-alerte" class="modal">
        <div class="modal-content">
            <h2 id="modal-title" style="color: var(--danger); margin-top:0;">‚ö†Ô∏è ALERTE</h2>
            <p id="modal-msg"></p>
            <button class="btn btn-close" onclick="closeModal()">FERMER</button>
        </div>
    </div>

    <div class="header">
        <img src="https://pitchoune-6.github.io/Poulailler-connect-/logo.png" alt="Logo" class="mon-logo">
        <div class="weather-widget">
            <span id="weather-icon">üåç</span> 
            <div>
                <span id="weather-temp" style="font-weight:bold;">--¬∞C</span><br>
                <span id="weather-desc" style="font-size:0.8em; color:#666;">Chargement...</span>
            </div>
        </div>
        <div class="status-pill">Pico: <span id="pico-status" style="color: grey;">Connexion...</span></div>
    </div>

    <h1 id="app-title">KokoriConnect</h1>

    <div id="tab-home" class="tab-content active">
        <div class="dashboard-grid">
            <div class="card"><div class="card-icon">üå°Ô∏è</div><h3>Temp√©rature</h3><p id="temp">--¬∞C</p></div>
            <div class="card"><div class="card-icon">üíß</div><h3>Humidit√©</h3><p id="hum">--%</p></div>
            <div class="card"><div class="card-icon">‚òÄÔ∏è</div><h3>Luminosit√©</h3><p id="lux">-- lux</p></div>
            <div class="card"><div class="card-icon">ü•ö</div><h3>≈íufs</h3><p id="oeufs">0</p></div>
            <div class="card">
                <h3>Eau</h3><p id="val-eau">--%</p>
                <div class="level-bar"><div id="fill-eau" class="level-fill" style="background: var(--info);"></div></div>
            </div>
            <div class="card">
                <h3>Grain</h3><p id="val-grain">--%</p>
                <div class="level-bar"><div id="fill-grain" class="level-fill" style="background: var(--warning);"></div></div>
            </div>
        </div>
    </div>

    <div id="tab-stats" class="tab-content">
        <div class="chart-container"><canvas id="tempChart"></canvas></div>
        <div class="chart-container"><canvas id="eggChart"></canvas></div>
        <div class="chart-container"><canvas id="levelChart"></canvas></div>
    </div>

    <div id="tab-actions" class="tab-content">
        <div class="control-panel">
            <div style="margin-bottom: 20px;">
                <h3>üè† Porte <span id="etat-porte" class="status-label">--</span></h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-open" onclick="sendCommand('porte/commande', 'open')">OUVRIR</button>
                    <button class="btn btn-close" onclick="sendCommand('porte/commande', 'close')">FERMER</button>
                </div>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
            <div style="margin-bottom: 20px;">
                <h3>üßπ Maintenance <span id="etat-racleur" class="status-label">--</span></h3>
                <button class="btn btn-clean" onclick="sendCommand('racleur/commande', 'open')">LANCER LE RACLEUR</button>
            </div>
            <button class="btn btn-export" onclick="exportToCSV()">üíæ EXPORTER (CSV)</button>
        </div>
    </div>

    <div id="tab-settings" class="tab-content">
        <div class="settings-group">
            <h3>üè∑Ô∏è Personnalisation</h3>
            <div class="form-row">
                <label>Nom du poulailler :</label>
                <input type="text" id="input-name" class="form-input" placeholder="Ex: Palace des Poules">
            </div>
        </div>

        <div class="settings-group">
            <h3>üåç Localisation (M√©t√©o)</h3>
            <div class="form-row">
                <label>Latitude :</label>
                <input type="number" step="0.0001" id="input-lat" class="form-input" placeholder="Ex: 47.658">
            </div>
            <div class="form-row">
                <label>Longitude :</label>
                <input type="number" step="0.0001" id="input-lon" class="form-input" placeholder="Ex: -2.760">
            </div>
            <button class="btn btn-clean" onclick="getMyGPS()">üìç Ma position actuelle</button>
        </div>

        <div class="settings-group">
            <h3>‚öôÔ∏è Automatisme Porte</h3>
            <div class="form-row">
                <label>Mode de fonctionnement :</label>
                <select id="input-mode" class="form-select">
                    <option value="MANUEL">Manuel (Boutons uniquement)</option>
                    <option value="AUTO_LUX">Automatique (Luminosit√©)</option>
                    <option value="AUTO_TIME">Horaires Fixes</option>
                </select>
            </div>
            <div class="form-row">
                <label>Heure d'ouverture :</label>
                <input type="time" id="input-open-time" class="form-input">
            </div>
            <div class="form-row">
                <label>Heure de fermeture :</label>
                <input type="time" id="input-close-time" class="form-input">
            </div>
        </div>

        <button class="btn btn-save" onclick="saveSettings()">üíæ SAUVEGARDER & ENVOYER</button>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active" onclick="switchTab('home', this)">
            <i class="nav-icon fas fa-home"></i>
            <span>Accueil</span>
        </button>
        <button class="nav-item" onclick="switchTab('stats', this)">
            <i class="nav-icon fas fa-chart-bar"></i>
            <span>Stats</span>
        </button>
        <button class="nav-item" onclick="switchTab('actions', this)">
            <i class="nav-icon fas fa-gamepad"></i>
            <span>Actions</span>
        </button>
        <button class="nav-item" onclick="switchTab('settings', this)">
            <i class="nav-icon fas fa-cog"></i>
            <span>R√©glages</span>
        </button>
    </div>

    <script>
        // --- NAVIGATION ---
        function switchTab(id, btn) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            btn.classList.add('active');
        }

        // --- CONFIG & GLOBALES ---
        const broker = "mqtt.dev.icam.school"; const port = 443; const rootTopic = "bzh/mecatro/dashboard/Kokoriconnect/";
        let userLat = 47.658; let userLon = -2.760; // Valeurs par d√©faut
        let lastMsg = Date.now(); let history = []; let client = null;

        // --- CHARTS ---
        const cOpt = { responsive:true, maintainAspectRatio:false };
        const tChart = new Chart(document.getElementById('tempChart'),{type:'line',data:{labels:[],datasets:[{label:'Temp. (¬∞C)',data:[],borderColor:'#e74c3c',fill:true,backgroundColor:'rgba(231,76,60,0.1)',tension:0.4}]},options:cOpt});
        const eChart = new Chart(document.getElementById('eggChart'),{type:'bar',data:{labels:[],datasets:[{label:'≈íufs',data:[],backgroundColor:'#f1c40f'}]},options:{...cOpt,scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});
        const lChart = new Chart(document.getElementById('levelChart'),{type:'line',data:{labels:[],datasets:[{label:'Eau %',data:[],borderColor:'#3498db'},{label:'Grain %',data:[],borderColor:'#f1c40f'}]},options:cOpt});

        // --- MQTT ---
        function startMQTT() {
            client = new Paho.MQTT.Client(broker, port, "app_" + Math.random().toString(16).substr(2, 6));
            client.onConnectionLost = () => updateStatus(false);
            client.onMessageArrived = (msg) => {
                const t = msg.destinationName.toLowerCase(); const p = msg.payloadString.trim();
                const h = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                lastMsg = Date.now(); updateStatus(true);

                if(t.includes("temperature")) { document.getElementById("temp").innerText=p; upC(tChart,h,parseFloat(p.replace(/[^\d.-]/g,''))); }
                if(t.includes("humidite")) document.getElementById("hum").innerText=p;
                if(t.includes("luminosite")) document.getElementById("lux").innerText=p;
                if(t.includes("nboeufs")) { document.getElementById("oeufs").innerText=p; upC(eChart,h,parseInt(p)); }
                if(t.includes("niveaueau")) { const v=parseInt(p); document.getElementById("val-eau").innerText=v+"%"; document.getElementById("fill-eau").style.width=v+"%"; upC(lChart,h,v,0); if(v<10) alertModal("EAU BASSE", v+"% restants !"); }
                if(t.includes("niveaugrain")) { const v=parseInt(p); document.getElementById("val-grain").innerText=v+"%"; document.getElementById("fill-grain").style.width=v+"%"; upC(lChart,h,v,1); if(v<10) alertModal("GRAIN BAS", v+"% restants !"); }
                if(t.includes("porte")) { const el=document.getElementById("etat-porte"); el.innerText=p.toUpperCase(); el.style.color=p.includes("ouverte")?"green":"red"; }
                if(t.includes("racleur")) { const el=document.getElementById("etat-racleur"); el.innerText=p.toUpperCase(); el.style.color=p.includes("fonctionnement")?"#3498db":"#333"; }
                if(t.includes("etatstock") && p.toUpperCase().includes("PLEIN")) alertModal("BLOCAGE", "Stock plein ou ≈ìuf coinc√© !");
                history.push({h,t,p});
            };
            client.connect({ onSuccess:()=>{updateStatus(true); client.subscribe(rootTopic+"#");}, useSSL:true });
        }

        // --- TOOLS ---
        function sendCommand(t, m) { 
            if(client && client.isConnected()){ 
                let msg = new Paho.MQTT.Message(m); 
                msg.destinationName = rootTopic + t; 
                client.send(msg); 
            } else { alert("Erreur : Non connect√© au MQTT"); }
        }

        function loadSettings() {
            const savedName = localStorage.getItem('appName');
            if(savedName) {
                document.getElementById('app-title').innerText = savedName;
                document.getElementById('input-name').value = savedName;
            }
            const savedLat = localStorage.getItem('userLat');
            const savedLon = localStorage.getItem('userLon');
            const savedMode = localStorage.getItem('userMode');
            const savedOpen = localStorage.getItem('userOpen');
            const savedClose = localStorage.getItem('userClose');

            if(savedLat) { userLat = savedLat; document.getElementById('input-lat').value = savedLat; }
            if(savedLon) { userLon = savedLon; document.getElementById('input-lon').value = savedLon; }
            if(savedMode) document.getElementById('input-mode').value = savedMode;
            if(savedOpen) document.getElementById('input-open-time').value = savedOpen;
            if(savedClose) document.getElementById('input-close-time').value = savedClose;
            initWeather();
        }

        function saveSettings() {
            const newName = document.getElementById('input-name').value;
            if(newName) { localStorage.setItem('appName', newName); document.getElementById('app-title').innerText = newName; }
            const lat = document.getElementById('input-lat').value;
            const lon = document.getElementById('input-lon').value;
            const mode = document.getElementById('input-mode').value;
            const openT = document.getElementById('input-open-time').value;
            const closeT = document.getElementById('input-close-time').value;

            if(lat) { localStorage.setItem('userLat', lat); userLat = lat; }
            if(lon) { localStorage.setItem('userLon', lon); userLon = lon; }
            localStorage.setItem('userMode', mode);
            localStorage.setItem('userOpen', openT);
            localStorage.setItem('userClose', closeT);

            initWeather();
            sendCommand("Config/Mode", mode);
            sendCommand("Config/HeureOuv", openT);
            sendCommand("Config/HeureFerm", closeT);
            alert("Param√®tres sauvegard√©s avec succ√®s !");
        }

        function getMyGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    document.getElementById('input-lat').value = pos.coords.latitude;
                    document.getElementById('input-lon').value = pos.coords.longitude;
                }, () => alert("GPS non accessible"));
            } else alert("GPS non support√©");
        }

        function initWeather() {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLon}&current_weather=true`)
            .then(r=>r.json()).then(d=>{
                if(d.current_weather){
                    document.getElementById("weather-temp").innerText=d.current_weather.temperature+"¬∞C";
                    document.getElementById("weather-desc").innerText="M√©t√©o locale";
                    document.getElementById("weather-icon").innerText=getWI(d.current_weather.weathercode);
                }
            }).catch(()=>{document.getElementById("weather-desc").innerText="Erreur M√©t√©o";});
        }
        function getWI(c){if(c===0)return"‚òÄÔ∏è";if(c<4)return"‚òÅÔ∏è";if(c<50)return"üå´Ô∏è";if(c<70)return"üåßÔ∏è";return"üå§Ô∏è";}

        function alertModal(t, m) { document.getElementById("modal-title").innerText=t; document.getElementById("modal-msg").innerText=m; document.getElementById("modal-alerte").style.display="block"; }
        function closeModal() { document.getElementById("modal-alerte").style.display="none"; }
        function upC(c,l,d,i=0) { c.data.labels.push(l); c.data.datasets[i].data.push(d); if(c.data.labels.length>10){c.data.labels.shift();c.data.datasets[i].data.shift();} c.update(); }
        function updateStatus(o) { document.getElementById('pico-status').innerText=o?"En ligne":"Hors ligne"; document.getElementById('pico-status').style.color=o?"green":"red"; }
        function exportToCSV() { let c="Heure,Topic,Valeur\n"; history.forEach(r=>c+=`${r.h},${r.t},${r.p}\n`); const b=new Blob([c],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='data.csv'; a.click(); }

        // START
        loadSettings(); 
        startMQTT();
        setInterval(()=>{if(Date.now()-lastMsg>35000)updateStatus(false);},5000);
    </script>
</body>
</html>
